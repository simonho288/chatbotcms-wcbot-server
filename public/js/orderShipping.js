"use strict";function SetupUI(){var e=$("#shipping_fee_form");e.form({on:"blur",inline:!0,fields:{ship_method:["empty"]}}),e.submit(function(e){return e.preventDefault(),!1}),$("#btn_proceed").click(onBtnProceed),$("#btn_back").click(onBtnBack)}function LoadShoppingCart(){return $.ajax({method:"GET",url:"/db_loadcart",data:{uid:window._userId,rid:window._recipientId}})}function LoadWcShipSetting(){return $.ajax({method:"GET",url:"/get_wc_ship_setting",timeout:15e3,data:{uid:window._userId,rid:window._recipientId}})}function LoadWcOrder(){return $.ajax({method:"GET",url:"/get_wc_order",data:{uid:window._userId,rid:window._recipientId,oid:window._orderId}})}function renderShipInfo(){function e(e){return e&&e.length>0?e:"--"}$("#first_name").html(e(window._wcOrder.shipping.first_name)),$("#last_name").html(e(window._wcOrder.shipping.last_name)),$("#address1").html(e(window._wcOrder.shipping.address_1)),$("#address2").html(window._wcOrder.shipping.address_2),$("#city").html(e(window._wcOrder.shipping.city)),$("#state").html(e(window._wcOrder.shipping.state)),$("#postcode").html(e(window._wcOrder.shipping.postcode)),$("#country").html(e(window._wcOrder.shipping.country))}function CalculateTotal(){var e=0,t=0;window._wcOrder.line_items.forEach(function(n){e+=parseFloat(n.subtotal),t+=parseFloat(n.total_tax)}),window._totalAmount=e;f=util.ParseCurrencyToDisp(window._shoppingCart.server_settings.currency,e);$("#order_totalamt").html(f);for(var n=[],i=null,o=0,r=_shipSettings.length;o<r;o++){var d=_shipSettings[o];if(0===d.locations.length)i=d;else{for(var a=!1,s=!1,c=!1,p=0,l=d.locations.length;p<l;p++){var w=d.locations[p];"country"===w.type?w.code===_wcOrder.shipping.country&&(a=!0):"postcode"===w.type&&(s=!0,IsPostcodeMatch(w.code,_wcOrder.shipping.postcode)&&(c=!0))}a&&(s?c&&n.push(d):n.push(d))}}var u='<option value="">Please select</option>';if(0===n.length){u+=MethodsToSelectOptionsMarkup(h="Locations not covered",i.methods)}else for(var o=0,r=n.length;o<r;++o){var _=n[o],h=_.zone.name;u+=MethodsToSelectOptionsMarkup(h,_.methods)}$('[name="ship_method"]').html(u);var f=util.ParseCurrencyToDisp(window._shoppingCart.server_settings.currency,t);$("#order_totaltax").html(f)}function MethodsToSelectOptionsMarkup(e,t){for(var n=window._shoppingCart.server_settings.currency,i="",o=0;o<t.length;++o){var r,d,a=t[o];switch(d=e+": ",a.method_id){case"free_shipping":if(r=0,"min_amount"===a.settings.requires.value){var s=parseFloat(a.settings.min_amount.value);if(window._totalAmount<s)continue}d+=a.method_title,d+=": Fee "+util.ParseCurrencyToDisp(n,0);break;case"flat_rate":case"local_pickup":r=ParseAndCalcShipCost(a.settings.cost.value),d+=a.method_title+": Fee "+util.ParseCurrencyToDisp(n,r)}i+="<option ",i+='value="'+a.method_id+'"',i+='data-title="'+a.method_title+'"',i+='data-cost="'+r+'">',i+=d,i+="</option>"}return i}function IsPostcodeMatch(e,t){var n=t.toLowerCase().trim(),i=e.toLowerCase().split("-");if(1===i.length)return i[0].trim()===n;if(2===i.length){var o=parseInt(i[0].trim()),r=parseInt(i[1].trim());if(o>r){var d=r;r=o,o=d}return(n=parseInt(n))>=o&&n<=r}return!1}function ParseAndCalcShipCost(e){if(null==e||""==e)return 0;var t=e.toLowerCase();return ParseWithLexer(t)}function EnableAllButtons(e){e?($("#btn_proceed").removeClass("disabled loading"),$("#btn_back").removeClass("disabled loading")):($("#btn_proceed").addClass("disabled loading"),$("#btn_back").addClass("disabled loading"))}function onBtnBack(e){e.preventDefault(),EnableAllButtons(!1),$.ajax({type:"DELETE",url:"/remove_wc_order",data:{oid:window._orderId,uid:window._userId,rid:window._recipientId}}).done(function(e){"ok"===e.status&&(window.location.href="/mwp?page=orderInfoInput&oid="+window._orderId+"&uid="+window._userId+"&rid="+window._recipientId)}).fail(function(e,t,n){EnableAllButtons(!0)})}function onBtnProceed(e){$("#shipping_fee_form").form("validate form")&&(EnableAllButtons(!1),$.when(SaveCart(),UpdateWcOrder()).done(function(e,t){"success"===e[1]&&"success"===t[1]&&(window.location.href="/mwp?page=orderReview&oid="+window._orderId+"&uid="+window._userId+"&rid="+window._recipientId)}).fail(function(e){EnableAllButtons(!0)}))}function SaveCart(){delete window._shoppingCart.input_info,delete window._shoppingCart.cart_items,delete window._shoppingCart.server_settings;var e=$('[name="ship_method"]');return window._shoppingCart.ship_info={wc_order_id:window._orderId,method:e.val(),cost:e.find(":selected").data("cost")},$.ajax({type:"POST",url:"/db_savecart",data:JSON.stringify({userId:window._userId,recipientId:window._recipientId,cart:window._shoppingCart}),contentType:"application/json"})}function UpdateWcOrder(){var e=$('[name="ship_method"]').find(":selected"),t={shipping_lines:[{method_id:e.val(),method_title:e.data("title"),total:e.data("cost")}]};return $.ajax({type:"PUT",url:"/update_wc_order",data:{userId:window._userId,recipientId:window._recipientId,orderId:window._orderId,updateProps:t}})}$(document).ready(function(){$.when(LoadShoppingCart(),LoadWcOrder(),LoadWcShipSetting()).done(function(e,t,n){window._shoppingCart=e[0],window._wcOrder=t[0],window._shipSettings=n[0],renderShipInfo(),CalculateTotal(),$(".loading_wrapper").hide(),$(".loaded_wrapper").show(),SetupUI()}).fail(function(e){})});