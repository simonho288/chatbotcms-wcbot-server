function CreateLexer(){var e=new Lexer;return e.addRule(REGEX_SPACE,function(){}),e.addRule(REGEX_FEE,function(e){return e}),e.addRule(REGEX_QTY,function(e){return e}),e.addRule(REGEX_NUM,function(e){return e}),e.addRule(/[\(\+\-\*\/\)]/,function(e){return e}),e}function ParseWithLexer(e){var r={precedence:2,associativity:"left"},t={precedence:1,associativity:"left"},n=CreateLexer(),a=new Parser({"+":t,"-":t,"*":r,"/":r}),s=[],u={"+":function(e,r){return e+r},"-":function(e,r){return e-r},"*":function(e,r){return e*r},"/":function(e,r){return e/r}};$.each(function(e){n.setInput(e);for(var r,t=[];r=n.lex();)t.push(r);return a.parse(t)}(e),function(e,r){switch(r){case"+":case"-":case"*":case"/":var t=+s.pop(),n=+s.pop();s.push(u[r](n,t));break;default:if(/^\d+/.test(r))s.push(parseFloat(r));else if(REGEX_QTY.test(r)){var a=CalcOrderTotalQty();s.push(a)}else if(REGEX_FEE.test(r)){var i,c,o=REGEX_FEE.exec(r)[2],f=/^.*percent\s*\=\s*"*(\s*[0-9]+)"*\s*/.exec(o);f&&2===f.length&&(i=parseFloat(f[1])),(f=/^.*min_fee\s*\=\s*"*(\s*[0-9]+)"*\s*/.exec(o))&&2===f.length&&(c=parseFloat(f[1]));var l=CalcFee(i,c);s.push(l)}}});var i=s.pop();return i}function CalcFee(e,r){var t=CalcOrderTotalAmount();return null!=e&&(t=t*e/100),null!=r&&(t=t<r?r:t),t}function CalcOrderTotalAmount(){var e=0;return $.each(window._wcOrder.line_items,function(r,t){e+=parseFloat(t.subtotal)}),e}function CalcOrderTotalQty(){var e=0;return $.each(window._wcOrder.line_items,function(r,t){e+=t.quantity}),e}function Parser(e){this.table=e}var REGEX_SPACE=/\s+/,REGEX_NUM=/[0-9]+(?:\.[0-9]+)?\b/,REGEX_QTY=/\[\s*(qty)\s*\]/,REGEX_FEE=/\[\s*(fee) \s*(.+?)\s*\]/;Parser.prototype.parse=function(e){for(var r=e.length,t=this.table,n=[],a=[],s=0;s<r;){switch(f=e[s++]){case"(":a.unshift(f);break;case")":for(;a.length;){if("("===(f=a.shift()))break;n.push(f)}if("("!==f)throw new Error("Mismatched parentheses.");break;default:if(t.hasOwnProperty(f)){for(;a.length;){var u=a[0];if("("===u)break;var i=t[f],c=i.precedence,o=t[u].precedence;if(c>o||c===o&&"right"===i.associativity)break;n.push(a.shift())}a.unshift(f)}else n.push(f)}}for(;a.length;){var f=a.shift();if("("===f)throw new Error("Mismatched parentheses.");n.push(f)}return n};